{% extends "base.html" %}

{% block title %}ì¡° ìƒì„¸ - ëŒ€ì¶œì•½ì •ì„œ ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">ğŸ  í™ˆ</a> &gt;
    <a href="/agreement/{{ agreement_id }}" id="agreementLink">ì•½ì •ì„œ</a> &gt;
    <span id="articleName">ì¡°</span>
</div>

<div class="page-header" id="headerSection">
    <h1 id="articleTitle">ë¡œë”© ì¤‘...</h1>
    <p class="subtitle" id="articleMeta"></p>
</div>

<!-- í•­ ëª©ë¡ ì„¹ì…˜ -->
<section class="clauses-section">
    <h2>ğŸ“ í•­(Clause) ëª©ë¡</h2>
    <p class="section-description">í•­ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í•­ì˜ ë‚´ìš©ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div id="clausesList" class="clauses-list">
        <div class="loading">ë¡œë”© ì¤‘...</div>
    </div>
</section>

<!-- í•­ ë‚´ìš© ëª¨ë‹¬ -->
<div id="clauseModal" class="modal hidden">
    <div class="modal-overlay" onclick="closeModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">í•­ ë‚´ìš©</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- í•­ ë‚´ìš©ì´ í‘œì‹œë  ê³³ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const agreementId = {{ agreement_id }};
    const articleId = {{ article_id }};
    const clausesList = document.getElementById('clausesList');
    const modal = document.getElementById('clauseModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    async function loadArticle() {
        try {
            // ì•½ì •ì„œ ì •ë³´ ë¡œë“œ
            const agreementResponse = await fetch(`/api/agreements/${agreementId}`);
            if (agreementResponse.ok) {
                const agreement = await agreementResponse.json();
                document.getElementById('agreementLink').textContent = agreement.name;
            }

            // ì¡° ì •ë³´ ë¡œë“œ
            const response = await fetch(`/api/agreements/${agreementId}/articles/${articleId}`);

            if (!response.ok) {
                if (response.status === 404) {
                    clausesList.innerHTML = '<p class="error-message">ì¡°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                throw new Error('Failed to load');
            }

            const article = await response.json();

            // í—¤ë” ì—…ë°ì´íŠ¸
            document.getElementById('articleName').textContent = `ì œ ${article.article_number_display} ì¡°`;
            document.getElementById('articleTitle').textContent = `ì œ ${article.article_number_display} ì¡° ${article.title}`;
            document.getElementById('articleMeta').textContent = `ğŸ“ ì´ ${article.clause_count}ê°œ í•­`;
            document.title = `ì œ ${article.article_number_display} ì¡° ${article.title} - ëŒ€ì¶œì•½ì •ì„œ ê´€ë¦¬ ì‹œìŠ¤í…œ`;

            // í•­ ëª©ë¡ í‘œì‹œ
            if (article.clauses.length === 0) {
                clausesList.innerHTML = '<p class="empty-message">í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            clausesList.innerHTML = article.clauses.map(clause => `
                <div class="clause-card card" onclick="showClauseContent(${JSON.stringify(clause).replace(/"/g, '&quot;')})">
                    <div class="clause-number">ì œ ${clause.clause_number_display} í•­</div>
                    <div class="clause-info">
                        <h3>${escapeHtml(clause.title)}</h3>
                        <p class="preview">${getContentPreview(clause.content)}</p>
                    </div>
                    <div class="clause-arrow">â–¶</div>
                </div>
            `).join('');

        } catch (error) {
            console.error(error);
            clausesList.innerHTML = '<p class="error-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    function getContentPreview(content) {
        if (!content) return '(ë‚´ìš© ì—†ìŒ)';

        let text = '';
        if (content.text) {
            text = content.text;
        } else if (content.lines && content.lines.length > 0) {
            text = content.lines.join(' ');
        } else if (typeof content === 'string') {
            text = content;
        }

        // ë¯¸ë¦¬ë³´ê¸°: ì²« 100ì
        if (text.length > 100) {
            return escapeHtml(text.substring(0, 100)) + '...';
        }
        return escapeHtml(text);
    }

    window.showClauseContent = function(clause) {
        modalTitle.textContent = `ì œ ${clause.clause_number_display} í•­ ${clause.title}`;

        let contentHtml = '';
        if (clause.content) {
            if (clause.content.lines && clause.content.lines.length > 0) {
                contentHtml = clause.content.lines.map(line => `<p>${escapeHtml(line)}</p>`).join('');
            } else if (clause.content.text) {
                contentHtml = `<p>${escapeHtml(clause.content.text).replace(/\n/g, '<br>')}</p>`;
            } else if (typeof clause.content === 'string') {
                contentHtml = `<p>${escapeHtml(clause.content).replace(/\n/g, '<br>')}</p>`;
            }
        }

        if (!contentHtml) {
            contentHtml = '<p class="empty-message">(ë‚´ìš© ì—†ìŒ)</p>';
        }

        modalBody.innerHTML = contentHtml;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeModal = function() {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    };

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeModal();
        }
    });

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    loadArticle();
});
</script>
{% endblock %}
