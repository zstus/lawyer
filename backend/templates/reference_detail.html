{% extends "base.html" %}

{% block title %}기준약정서 상세 - 대출약정서 생성 시스템{% endblock %}

{% block nav_reference %}active{% endblock %}

{% block content %}
<div class="detail-page">
    <!-- 헤더 -->
    <div class="detail-header">
        <h1 id="agreementTitle" class="detail-title">로딩 중...</h1>
        <div class="detail-meta">
            <span id="agreementFile"></span>
            <span id="agreementDate"></span>
        </div>
    </div>

    <!-- 조/항 목록 (아코디언) -->
    <div id="articlesList" class="articles-accordion">
        <div class="loading">로딩 중...</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const agreementId = {{ agreement_id }};
    const articlesList = document.getElementById('articlesList');

    async function loadAgreement() {
        try {
            const response = await fetch(`/api/agreements/${agreementId}`);

            if (!response.ok) {
                if (response.status === 404) {
                    articlesList.innerHTML = '<p class="error-message">약정서를 찾을 수 없습니다.</p>';
                    return;
                }
                throw new Error('Failed to load');
            }

            const agreement = await response.json();

            // 헤더 업데이트
            document.getElementById('agreementTitle').textContent = agreement.name;
            document.getElementById('agreementFile').textContent = agreement.file_name;
            document.getElementById('agreementDate').textContent = `생성일 ${formatDate(agreement.created_at)}`;
            document.title = `${agreement.name} - 대출약정서 생성 시스템`;

            // 조 목록이 없는 경우
            if (agreement.articles.length === 0) {
                articlesList.innerHTML = '<p class="empty-message">조항이 없습니다.</p>';
                return;
            }

            // 조/항 아코디언 생성
            articlesList.innerHTML = agreement.articles.map(article => `
                <div class="accordion-article">
                    <div class="accordion-article-header" onclick="toggleArticle(this)">
                        <span class="article-label">제${article.article_number_display}조</span>
                        <span class="article-title">${escapeHtml(article.title)}</span>
                        <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div class="accordion-article-content" id="article-${article.id}">
                        <div class="loading-clauses">항 목록 로딩 중...</div>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            console.error(error);
            articlesList.innerHTML = '<p class="error-message">데이터를 불러올 수 없습니다.</p>';
        }
    }

    // 조 아코디언 토글
    window.toggleArticle = async function(header) {
        const content = header.nextElementSibling;
        const isOpen = content.classList.contains('open');

        // 다른 열린 항목 닫기 (선택적)
        // document.querySelectorAll('.accordion-article-content.open').forEach(el => {
        //     el.classList.remove('open');
        //     el.previousElementSibling.classList.remove('open');
        // });

        if (isOpen) {
            content.classList.remove('open');
            header.classList.remove('open');
        } else {
            content.classList.add('open');
            header.classList.add('open');

            // 항 목록이 로드되지 않았으면 로드
            if (content.querySelector('.loading-clauses')) {
                const articleId = content.id.replace('article-', '');
                await loadClauses(articleId, content);
            }
        }
    };

    // 항 목록 로드
    async function loadClauses(articleId, container) {
        try {
            const response = await fetch(`/api/agreements/${agreementId}/articles/${articleId}`);
            const article = await response.json();

            if (article.clauses.length === 0) {
                container.innerHTML = '<p class="empty-clauses">항이 없습니다.</p>';
                return;
            }

            container.innerHTML = article.clauses.map(clause => `
                <div class="accordion-clause">
                    <div class="accordion-clause-header" onclick="toggleClause(this)">
                        <span class="clause-label">제${clause.clause_number_display}항</span>
                        <span class="clause-title">${escapeHtml(clause.title)}</span>
                        <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div class="accordion-clause-content">
                        <div class="clause-content-text">${formatClauseContent(clause.content)}</div>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            container.innerHTML = '<p class="error-message">항 목록을 불러올 수 없습니다.</p>';
        }
    }

    // 항 아코디언 토글
    window.toggleClause = function(header) {
        const content = header.nextElementSibling;
        const isOpen = content.classList.contains('open');

        if (isOpen) {
            content.classList.remove('open');
            header.classList.remove('open');
        } else {
            content.classList.add('open');
            header.classList.add('open');
        }
    };

    function formatClauseContent(content) {
        if (!content) return '<p class="no-content">(내용 없음)</p>';

        let text = '';
        if (content.text) {
            text = content.text;
        } else if (content.lines && content.lines.length > 0) {
            text = content.lines.join('\n');
        } else if (typeof content === 'string') {
            text = content;
        }

        if (!text) return '<p class="no-content">(내용 없음)</p>';

        // 줄바꿈을 <br>로 변환하고 단락 처리
        return text.split('\n').map(line =>
            `<p>${escapeHtml(line) || '&nbsp;'}</p>`
        ).join('');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return `${date.getFullYear()}.${date.getMonth() + 1}.${date.getDate()}`;
    }

    // 초기 로드
    loadAgreement();
});
</script>
{% endblock %}
