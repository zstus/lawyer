{% extends "base.html" %}

{% block title %}작업약정서 - 대출약정서 생성 시스템{% endblock %}

{% block nav_work %}active{% endblock %}

{% block content %}
<div class="list-page">
    <!-- 신규생성 버튼 -->
    <div class="action-bar">
        <button id="createBtn" class="btn btn-primary btn-upload">대출약정서 신규생성</button>
    </div>

    <!-- 약정서 목록 -->
    <div id="workList" class="agreement-list">
        <div class="loading">로딩 중...</div>
    </div>
</div>

<!-- 신규생성 모달 -->
<div id="createModal" class="modal hidden">
    <div class="modal-overlay" onclick="closeCreateModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>작업약정서 신규생성</h3>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createForm">
                <div class="form-group">
                    <label for="agreementName">약정서 이름 *</label>
                    <input type="text" id="agreementName" name="name" required placeholder="예: OO프로젝트 대출약정서">
                </div>
                <div class="form-group">
                    <label for="agreementDescription">설명 (선택)</label>
                    <textarea id="agreementDescription" name="description" rows="3" placeholder="약정서에 대한 설명"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">취소</button>
                    <button type="submit" class="btn btn-primary" id="submitCreateBtn">생성</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const createBtn = document.getElementById('createBtn');
    const createModal = document.getElementById('createModal');
    const createForm = document.getElementById('createForm');
    const workList = document.getElementById('workList');

    // 모달 열기
    createBtn.addEventListener('click', () => {
        createModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    });

    // 모달 닫기
    window.closeCreateModal = function() {
        createModal.classList.add('hidden');
        document.body.style.overflow = '';
        createForm.reset();
    };

    // 폼 제출
    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            name: document.getElementById('agreementName').value,
            description: document.getElementById('agreementDescription').value || null
        };

        try {
            const response = await fetch('/api/generated/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                closeCreateModal();
                loadWorkAgreements();
            } else {
                alert(data.detail || '생성 실패');
            }
        } catch (error) {
            alert('생성 중 오류가 발생했습니다.');
        }
    });

    // 작업약정서 목록 로드
    async function loadWorkAgreements() {
        try {
            const response = await fetch('/api/generated/');
            const agreements = await response.json();

            if (agreements.length === 0) {
                workList.innerHTML = '<p class="empty-message">생성된 작업약정서가 없습니다.</p>';
                return;
            }

            workList.innerHTML = agreements.map(a => {
                // 최근 작업 정보 생성
                let recentWork = '';
                if (a.article_count > 0) {
                    recentWork = `최근작업: ${a.article_count}개 조항`;
                }

                return `
                <div class="agreement-item" onclick="location.href='/work/${a.id}'">
                    <div class="agreement-info">
                        <h3 class="agreement-title">${escapeHtml(a.name)}</h3>
                        <p class="agreement-meta">${recentWork || '조항 없음'}</p>
                    </div>
                    <div class="agreement-right">
                        <span class="agreement-date">생성일 ${formatDate(a.created_at)}</span>
                        <button class="btn-icon btn-delete" onclick="deleteWork(event, ${a.id}, '${escapeHtml(a.name)}')" title="삭제">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `}).join('');
        } catch (error) {
            workList.innerHTML = '<p class="error-message">목록을 불러올 수 없습니다.</p>';
        }
    }

    // 작업약정서 삭제
    window.deleteWork = async function(event, id, name) {
        event.stopPropagation();
        if (!confirm(`"${name}" 작업약정서를 삭제하시겠습니까?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/generated/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadWorkAgreements();
            } else {
                alert('삭제에 실패했습니다.');
            }
        } catch (error) {
            alert('삭제 중 오류가 발생했습니다.');
        }
    };

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return `${date.getFullYear()}.${date.getMonth() + 1}.${date.getDate()}`;
    }

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !createModal.classList.contains('hidden')) {
            closeCreateModal();
        }
    });

    // 초기 로드
    loadWorkAgreements();
});
</script>
{% endblock %}
