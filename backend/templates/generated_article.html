{% extends "base.html" %}

{% block title %}생성 조 상세 - 대출약정서 관리 시스템{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">홈</a> &gt;
    <a href="/generated">생성 약정서</a> &gt;
    <a href="/generated/{{ agreement_id }}" id="agreementLink">약정서</a> &gt;
    <span id="articleName">조</span>
</div>

<div class="page-header" id="headerSection">
    <h1 id="articleTitle">로딩 중...</h1>
    <p class="subtitle" id="articleMeta"></p>
</div>

<!-- 참조 정보 섹션 -->
<section class="reference-section card" id="referenceSection" style="display: none;">
    <h2>참조 정보</h2>
    <div id="referenceInfo"></div>
</section>

<!-- Term Sheet 섹션 -->
<section class="termsheet-section card" id="termsheetSection" style="display: none;">
    <h2>사용된 Term Sheet</h2>
    <pre id="termsheetContent"></pre>
</section>

<!-- 항 목록 섹션 -->
<section class="clauses-section">
    <div class="section-header">
        <h2>생성된 항(Clause) 목록</h2>
        <button class="btn btn-primary" onclick="showAddClauseModal()">항 추가</button>
    </div>

    <div id="clausesList" class="clauses-list">
        <div class="loading">로딩 중...</div>
    </div>
</section>

<!-- 항 내용 편집 모달 -->
<div id="clauseModal" class="modal hidden">
    <div class="modal-overlay" onclick="closeModal()"></div>
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="modalTitle">항 내용</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="clauseForm">
                <input type="hidden" id="clauseId">
                <div class="form-group">
                    <label for="clauseNumber">항 번호</label>
                    <input type="text" id="clauseNumber" name="clause_number_display" placeholder="예: 1, 2, 1의2">
                </div>
                <div class="form-group">
                    <label for="clauseTitle">항 제목</label>
                    <input type="text" id="clauseTitle" name="title" placeholder="항 제목">
                </div>
                <div class="form-group">
                    <label for="clauseContent">내용</label>
                    <textarea id="clauseContent" name="content" rows="15" placeholder="AI 생성 내용 또는 직접 입력"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">저장</button>
                    <button type="button" class="btn btn-danger" id="deleteClauseBtn" style="display: none;" onclick="deleteCurrentClause()">삭제</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const agreementId = {{ agreement_id }};
    const articleId = {{ article_id }};
    const clausesList = document.getElementById('clausesList');
    const modal = document.getElementById('clauseModal');
    const modalTitle = document.getElementById('modalTitle');
    const clauseForm = document.getElementById('clauseForm');
    const deleteClauseBtn = document.getElementById('deleteClauseBtn');

    let currentArticle = null;

    async function loadArticle() {
        try {
            // 약정서 정보 로드
            const agreementResponse = await fetch(`/api/generated/${agreementId}`);
            if (agreementResponse.ok) {
                const agreement = await agreementResponse.json();
                document.getElementById('agreementLink').textContent = agreement.name;
            }

            // 조 정보 로드
            const response = await fetch(`/api/generated/${agreementId}/articles/${articleId}`);

            if (!response.ok) {
                if (response.status === 404) {
                    clausesList.innerHTML = '<p class="error-message">조를 찾을 수 없습니다.</p>';
                    return;
                }
                throw new Error('Failed to load');
            }

            currentArticle = await response.json();

            // 헤더 업데이트
            const articleDisplay = currentArticle.article_number_display ? `제 ${currentArticle.article_number_display} 조` : '(번호 미지정)';
            document.getElementById('articleName').textContent = articleDisplay;
            document.getElementById('articleTitle').textContent = `${articleDisplay} ${currentArticle.title || ''}`;
            document.getElementById('articleMeta').textContent = `항 ${currentArticle.clause_count}개 | 생성일 ${formatDate(currentArticle.created_at)}`;
            document.title = `${articleDisplay} ${currentArticle.title || ''} - 대출약정서 관리 시스템`;

            // 참조 정보 표시
            if (currentArticle.ref_agreement_id || currentArticle.ref_article_id) {
                document.getElementById('referenceSection').style.display = 'block';
                let refInfo = [];
                if (currentArticle.ref_agreement_id) {
                    refInfo.push(`참조 약정서 ID: ${currentArticle.ref_agreement_id}`);
                }
                if (currentArticle.ref_article_id) {
                    refInfo.push(`참조 조 ID: ${currentArticle.ref_article_id}`);
                }
                document.getElementById('referenceInfo').innerHTML = refInfo.map(r => `<p>${r}</p>`).join('');
            }

            // Term Sheet 표시
            if (currentArticle.term_sheet_text) {
                document.getElementById('termsheetSection').style.display = 'block';
                document.getElementById('termsheetContent').textContent = currentArticle.term_sheet_text;
            }

            // 항 목록 표시
            if (currentArticle.clauses.length === 0) {
                clausesList.innerHTML = `
                    <div class="empty-message">
                        <p>생성된 항이 없습니다.</p>
                        <button class="btn btn-primary" onclick="showAddClauseModal()">항 추가</button>
                    </div>
                `;
                return;
            }

            clausesList.innerHTML = currentArticle.clauses.map(clause => `
                <div class="clause-card card" onclick="showEditClauseModal(${clause.id})">
                    <div class="clause-number">${clause.clause_number_display ? `제 ${clause.clause_number_display} 항` : '(번호 미지정)'}</div>
                    <div class="clause-info">
                        <h3>${escapeHtml(clause.title || '(제목 없음)')}</h3>
                        <p class="preview">${getContentPreview(clause.content)}</p>
                        <p class="meta">
                            ${clause.ref_clause_id ? '<span class="badge">참조 있음</span>' : ''}
                            <span>수정 ${formatDate(clause.updated_at)}</span>
                        </p>
                    </div>
                    <div class="clause-arrow">▶</div>
                </div>
            `).join('');

        } catch (error) {
            console.error(error);
            clausesList.innerHTML = '<p class="error-message">데이터를 불러올 수 없습니다.</p>';
        }
    }

    function getContentPreview(content) {
        if (!content) return '(내용 없음)';
        const text = typeof content === 'string' ? content : JSON.stringify(content);
        if (text.length > 150) {
            return escapeHtml(text.substring(0, 150)) + '...';
        }
        return escapeHtml(text);
    }

    // 항 추가 모달
    window.showAddClauseModal = function() {
        modalTitle.textContent = '새 항 추가';
        document.getElementById('clauseId').value = '';
        document.getElementById('clauseNumber').value = '';
        document.getElementById('clauseTitle').value = '';
        document.getElementById('clauseContent').value = '';
        deleteClauseBtn.style.display = 'none';
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    // 항 편집 모달
    window.showEditClauseModal = function(clauseId) {
        const clause = currentArticle.clauses.find(c => c.id === clauseId);
        if (!clause) return;

        modalTitle.textContent = `항 편집: ${clause.clause_number_display || ''} ${clause.title || ''}`;
        document.getElementById('clauseId').value = clause.id;
        document.getElementById('clauseNumber').value = clause.clause_number_display || '';
        document.getElementById('clauseTitle').value = clause.title || '';
        document.getElementById('clauseContent').value = clause.content || '';
        deleteClauseBtn.style.display = 'inline-block';
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeModal = function() {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    };

    // 폼 제출 (추가/수정)
    clauseForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const clauseId = document.getElementById('clauseId').value;
        const formData = {
            clause_number_display: document.getElementById('clauseNumber').value || null,
            title: document.getElementById('clauseTitle').value || null,
            content: document.getElementById('clauseContent').value || null
        };

        // clause_number 숫자 추출
        const numberMatch = formData.clause_number_display?.match(/\d+/);
        if (numberMatch) {
            formData.clause_number = parseInt(numberMatch[0]);
        }

        try {
            let response;
            if (clauseId) {
                // 수정
                response = await fetch(`/api/generated/${agreementId}/articles/${articleId}/clauses/${clauseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
            } else {
                // 추가
                response = await fetch(`/api/generated/${agreementId}/articles/${articleId}/clauses`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
            }

            if (response.ok) {
                closeModal();
                loadArticle();
            } else {
                const data = await response.json();
                alert(data.detail || '저장 실패');
            }
        } catch (error) {
            alert('저장 중 오류가 발생했습니다.');
        }
    });

    // 항 삭제
    window.deleteCurrentClause = async function() {
        const clauseId = document.getElementById('clauseId').value;
        if (!clauseId) return;

        if (!confirm('이 항을 삭제하시겠습니까?')) {
            return;
        }

        try {
            const response = await fetch(`/api/generated/${agreementId}/articles/${articleId}/clauses/${clauseId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                closeModal();
                loadArticle();
            } else {
                alert('삭제에 실패했습니다.');
            }
        } catch (error) {
            alert('삭제 중 오류가 발생했습니다.');
        }
    };

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeModal();
        }
    });

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('ko-KR');
    }

    loadArticle();
});
</script>
{% endblock %}
